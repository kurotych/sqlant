name: CI Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: mydb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          -v ${{ github.workspace }}/certs:/var/lib/postgresql/certs
          -e POSTGRES_INITDB_ARGS="--auth=md5"
          -e POSTGRES_SSL=on
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate SSL Certificates
        run: |
          mkdir -p certs
          openssl req -new -x509 -days 365 -nodes -out certs/server.crt -keyout certs/server.key -subj "/CN=localhost"
          chmod 600 certs/server.key

      - name: Restart PostgreSQL with SSL
        run: |
          docker stop $(docker ps -q --filter ancestor=postgres) || true
          docker run -d \
            -v ${{ github.workspace }}/certs:/var/lib/postgresql/certs \
            -e POSTGRES_USER=user \
            -e POSTGRES_PASSWORD=password \
            -e POSTGRES_DB=mydb \
            -p 5432:5432 \
            postgres:latest \
            -c ssl=on \
            -c ssl_cert_file=/var/lib/postgresql/certs/server.crt \
            -c ssl_key_file=/var/lib/postgresql/certs/server.key

      - name: Connect to PostgreSQL with SSL
        run: |
          PGPASSWORD=password psql "sslmode=require host=localhost dbname=mydb user=user"
